<!DOCTYPE>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Copybook to Java Class Converter</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/theme/twilight.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/codemirror.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/mode/clike/clike.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/edit/matchbrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/addon/selection/active-line.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.8.0/mode/cobol/cobol.js"></script>
</head>
<body>

<div style="width: 100%">
    <div style="float: left;">
        <p>Copybook:</p>
        <textarea id="copybook" name="copybook" cols="80" rows="50">
                        * Comment stuff
            01 SUBFIELD.  * Lineending comment
                02 COUNT PIC 9(2).
            * Comment stuff ...
            01 RESULT. 
                                                        * Comment stuff
                02 FIELDS OCCURS 0 TO 10 TIMES PIC X(8) DEPENDING ON
                                                        COUNT
                                                        IN SUBFIELD. 
            * Comment stuff
            01 SUBFIELD2. 
                02 COUNT1 PIC 9(2).
                02 COUNT2 PIC 9(2).
            01 FIELD PIC X(10).
            01 STUFFS OCCURS 10 TIMES.
                02 STUFF PIC X(8).
        </textarea>
    </div>

    <div style="float: left;">
        <p>Java Class:</p>

        <div>
            <div>
                <span>Subclass</span>
                <select id="subclass">
                    <option value="none">None</option>
                    <option value="nested">nested</option>
                </select>
                <span>Accessors</span>
                <select id="accessorpattern">
                    <option value="none">None</option>
                    <option value="getset">Getter/setter</option>
                    <option value="lombokdata">Lombok Data</option>
                </select>
                <span>Charset</span>
                <input id="charset" type="text" value="UTF-8">
            </div>
        </div>

        <textarea id="javaclass" name="javaclass"></textarea>
    </div>
    <br style="clear: left;"/>
</div>

<script type="application/javascript">

    /*** convertCopybook start ***/
    function convertCopybook (rootClassName, str, accessor, charset, subclass) {
        var fields = [];

        (function parseCopybook(copybook) {
            var last = [{ level: 0, fields: fields }];
            copybook.replace(/\*[^\n]*/g, '').match(/[\s\S]+?\.[\s\t]*\n/g).forEach(function(line, i) {
                // Remove comments, newlines, extra space and trim
                line = line.replace(/\s*\*[^\n]+\n/g, '').replace(/\n/g, ' ').replace(/\s{2,}/g, ' ').replace(/^\s+/, '').replace(/\s+$/, '');

                if(match = line.match(/^\s*(\d+)\s+([^\s]+)((?:\s+OCCURS\s+\d+(?:\s+TO\s+\d+)?\s+TIMES)|(?:\s+REDEFINES\s+[^\s]+))?(\s+PIC\s+[^\s]+)?(\s+DEPENDING\s+ON\s+[^\s]+(?:\s+IN\s+[^\s+]+)?)?\s*\.\s*$/)) {
                    var level = parseInt(match[1]);
                    var name = match[2];

                    var current = {
                        name: name,
                        level: level,
                        lines: [ line ],
                        fields: [],
                        type: ''
                    };

                    if (match[4] != undefined) {
                        if(pic_match = match[4].match(/^\s*PIC\s+(S)?(X+|9+)(?:\((\d+)\))?(?:V(9+)(?:\((\d+)\))?)?\s*$/)) {
                            var signed = pic_match[1] !== undefined ? true : false;
                            var main_type = pic_match[2];
                            var main_size = pic_match[3] !== undefined ? parseInt(pic_match[3]) : main_type.length;
                            var decimal_type = pic_match[4] !== undefined ?  match[4] : "";
                            var decimal_size = pic_match[5] != undefined ? parseInt(pic_match[5]) : decimal_type.length;

                            if (main_type.indexOf("X") === 0) {
                                current['type'] = "String";

                            } else if (main_type.indexOf("9") === 0 && decimal_type !== '') { // Signed or unsigned decimal type
                                current['type'] = "BigDecimal";

                            } else if (main_type.indexOf("9") === 0 && decimal_type === '') { // Signed or unsigned integer type
                                if(main_size < 10) {
                                    current['type'] = "int";

                                } else {
                                    current['type'] = "BigInteger";
                                }
                            }

                        }
                    }

                    if(match[3] != undefined) {
                        if (occurs_match = match[3].match(/^\s*OCCURS\s+(?:(\d+)\s+TO\s+)?(\d+)\s+TIMES\s*$/)) {
                            current['type'] += "[]";

                        } else if (redefines_match = match[3].match(/\s*REDEFINES\s+([^\s]+)\s*/)) {

                        }
                    }

                    if(match[5] != undefined) {
                        if(depending_match = match[5].match(/^\s*DEPENDING\s+ON\s+([^\s]+)(?:\s+IN\s+([^\s]+))?\s*$/)) {

                        }
                    }

                    while(last.length > 0) {
                        if(level > last[last.length - 1]['level']) {
                            last[last.length - 1]['fields'].push(current);
                            last.push(current);
                            break;

                        } else if (level === last[last.length - 1]['level']) {
                            last[last.length - 2]['fields'].push(current);
                            last[last.length - 1] = current;
                            break;

                        } else {
                            last.pop();
                        }
                    }
                }
            });
        }(str));

        // Simplify structure
        (function simplifyStructure(fields, parent) {
            var types = 0;
            fields.forEach(function(field, i){
                if(field["type"] && field["type"] !== '[]') {
                    types++;

                } else if (field["fields"].length > 0) {
                    types += simplifyStructure(field["fields"], field);
                }
            });

            if(types < 2) {
                fields.forEach(function(field, i) {
                    parent["name"] = parent["name"] + "." + field["name"];
                    parent["lines"] = parent["lines"].concat(field["lines"]);
                    parent["type"] = field["type"] ? field["type"] + (parent["type"] ? parent["type"] : '') : parent["type"];
                });
                parent["fields"] = [];
            }

            return types;
        })(fields, fields);

        // Generate java class
        var classes = [];
        (function generateJavaClasses(classname, fields, indentation, level) {
            var currentClass = "";
            var subclasses = "";
            currentClass += " ".repeat(level * indentation) + "@CopyBook(charset = \""+ charset +"\")\n";
            currentClass += " ".repeat(level * indentation)
                    + (accessor === "lombokdata" ? "@Data " : "")
                    + (subclass === "nested" && level > 0 ? "public static " : "")
                    + "class "+ classname + " {\n";

            fields.forEach(function(field, i){
                var java_name = toCamelCase(field["name"].replace(".", "_"));

                field["lines"].forEach(function(line, j) {
                    currentClass += " ".repeat(level * indentation + indentation) + "@CopyBookLine(\"" + line + "\")\n";
                });

                if (field["fields"].length > 0) {
                    currentClass += " ".repeat(level * indentation + indentation) + "private " + toCapitalCase(java_name) + " " + java_name + ";\n";
                    subclasses = generateJavaClasses(toCapitalCase(java_name), field["fields"], indentation, subclass === "nested" ? (level + 1) : level);

                } else {
                    currentClass += " ".repeat(level * indentation + indentation) + "private " + field["type"] + " " + java_name + ";\n";
                }

                if(fields.length -1 > i) { currentClass += "\n"; }
            });

            if(accessor === "getset") {
                currentClass += "\n";
                fields.forEach(function (field, i) {
                    var java_name = toCamelCase(field["name"].replace(".", "_"));
                    var java_type = field["fields"].length > 0 ? toCapitalCase(java_name) : field["type"];

                    currentClass += " ".repeat(level * indentation + indentation) + "public " + java_type + " get" + toCapitalCase(java_name) + "() {\n";
                    currentClass += " ".repeat(level * indentation + indentation * 2) + "return this." + java_name + ";\n";
                    currentClass += " ".repeat(level * indentation + indentation) + "}\n";
                    currentClass += "\n";
                    currentClass += " ".repeat(level * indentation + indentation) + "public void set" + toCapitalCase(java_name) + "(" + java_type + " " + java_name + ") {\n";
                    currentClass += " ".repeat(level * indentation + indentation * 2) + "this." + java_name + " = " + java_name + ";\n";
                    currentClass += " ".repeat(level * indentation + indentation) + "}\n";

                    if(fields.length -1 > i) { currentClass += "\n"; }
                });
            }

            if(level > 0) {
                currentClass += " ".repeat(level * indentation) + "}\n";
                return "\n" + currentClass;

            } else {
                currentClass += subclasses;
                currentClass += " ".repeat(level * indentation) + "}\n";
                classes.push(currentClass);
            }

            return "";
        })(rootClassName, fields, 4, 0);

        return classes;
    }

    function toCamelCase(str) {
        return str.toLocaleLowerCase().replace(/([\-_]\w)/g, function(m){ return m[1].toUpperCase(); });
    }

    function toCapitalCase(str) {
        return str.charAt(0).toUpperCase() + str.slice(1)
    }
    
    // Polyfill
    if (!String.prototype.repeat) {
        String.prototype.repeat = function(count) {
            'use strict';
            if (this == null) {
                throw new TypeError('can\'t convert ' + this + ' to object');
            }
            var str = '' + this;
            count = +count;
            if (count != count) {
                count = 0;
            }
            if (count < 0) {
                throw new RangeError('repeat count must be non-negative');
            }
            if (count == Infinity) {
                throw new RangeError('repeat count must be less than infinity');
            }
            count = Math.floor(count);
            if (str.length == 0 || count == 0) {
                return '';
            }
            // Ensuring count is a 31-bit integer allows us to heavily optimize the
            // main part. But anyway, most current (August 2014) browsers can't handle
            // strings 1 << 28 chars or longer, so:
            if (str.length * count >= 1 << 28) {
                throw new RangeError('repeat count must not overflow maximum string size');
            }
            var rpt = '';
            for (;;) {
                if ((count & 1) == 1) {
                    rpt += str;
                }
                count >>>= 1;
                if (count == 0) {
                    break;
                }
                str += str;
            }
            // Could we try:
            // return Array(count + 1).join(this);
            return rpt;
        }
    }
    /*** convertCopybook stop ***/
</script>

<script type="application/javascript">
    function updateEditor(srcEditor, dstEditor) {
        var subclassSelector = document.getElementById("subclass");
        var subclass = subclassSelector.options[subclassSelector.selectedIndex].value;
        var accessorSelector = document.getElementById("accessorpattern");
        var accessor = accessorSelector.options[accessorSelector.selectedIndex].value;
        var charset = document.getElementById("charset").value;
        var src = srcEditor.getValue();
        var classes = convertCopybook("RenameMeCopyBook", src, accessor, charset, subclass);

        var classHeader = [
            "package " + "renamemepackage" + ";\n",
            "import dk.nversion.copybook.annotations.CopyBook;",
            "import dk.nversion.copybook.annotations.CopyBookLine;"
        ].join("\n")

        var dst = classHeader + "\n\n" + classes.join("\n");

        dstEditor.setValue(dst);
        dstEditor.refresh();
    }

    $(function() {
        var javaEditor = CodeMirror.fromTextArea(document.getElementById("javaclass"), {
            lineNumbers: true,
            matchBrackets: true,
            mode: "text/x-java",
            viewportMargin: Infinity
        });
        javaEditor.setSize(null, 750);

        var cobolEditor = CodeMirror.fromTextArea(document.getElementById("copybook"), {
            lineNumbers: true,
            matchBrackets: true,
            mode: "text/x-cobol",
            viewportMargin: Infinity,
            styleActiveLine: true,
            theme : "twilight",
            showCursorWhenSelecting : true
        });

        cobolEditor.setSize(null, 750);
        cobolEditor.on("change", function (cm) {
            updateEditor(cm, javaEditor);
        });

        $("#accessorpattern").change(function() {
            updateEditor(cobolEditor, javaEditor);
        });

        $("#charset").change(function() {
            updateEditor(cobolEditor, javaEditor);
        });

        $("#subclass").change(function() {
            updateEditor(cobolEditor, javaEditor);
        });

        updateEditor(cobolEditor, javaEditor);
    });
  </script>

</body>
</html>
