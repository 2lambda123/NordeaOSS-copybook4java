<!DOCTYPE>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Copybook to Java Class Converter</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>
</html>
<body>

<div style="width: 100%">
    <div style="float: left;">
        <p>Copybook:</p>
        <textarea name="copybook" cols="80" rows="50"></textarea>
    </div>

    <div style="float: left;">
        <p>Java Class:</p>
        <textarea name="javaclass" cols="80" rows="50"></textarea>
    </div>
    <br style="clear: left;"/>
</div>

<script type="application/javascript">

    function convertCopybook (str) {
        re_pic = /(\d+)\s+([^\s]+)\s+PIC\s+(S)?(X+|9+)(?:\((\d+)\))?(?:V(9+)(?:\((\d+)\))?)?\s*\./;
        re_occurs = /(\d+)\s+([^\s]+)\s+OCCURS\s+(\d+)\s+TIMES\s*./;
        re_name = /(\d+)\s+([^\s]+)\s*\./;

        var lines = str.split('\n');
        var result = "";
        for(var i = 0;i < lines.length;i++){
            var line = lines[i];
            var match;
            if(match = re_pic.exec(line)) {
                var level = parseInt(match[1]);
                var name =  match[2];
                var signed = match[3] !== undefined ? true : false;
                var main_type = match[4];
                var main_size = match[5] !== undefined ? parseInt(match[5]) : main_type.length;
                var decimal_type = match[6] !== undefined ?  match[6] : "";
                var decimal_size = match[7] != undefined ? parseInt(match[7]) : decimal_type.length;

                var java_name = toCamelCase(name);
                result += "@CopyBookLine(\"" + line.trim() + "\")\n";

                if (main_type.indexOf("X") === 0) {
                    result += "private String " + java_name + ";\n";

                } else if (main_type.indexOf("9") === 0 && decimal_type !== '') { // Signed or unsigned decimal type
                    result += "private BigDecimal " + java_name + ";\n";

                } else if (main_type.indexOf("9") === 0 && decimal_type === '') { // Signed or unsigned integer type
                    if(main_size < 10) {
                        result += "private int " + java_name + ";\n";
                    } else {
                        result += "private BigInteger " + java_name + ";\n";
                    }
                }
                result += "\n";
            } else if (match = re_occurs.exec(line)) {
                var level = match[1];
                var name = match[2];
                var java_name = toCamelCase(name);
                result += "@CopyBookLine(\"" + line.trim() + "\")\n";
                result += "private " + toCapitalCase(java_name) + "[] " + java_name + ";\n";
                result += "\n";

            } else if (match = re_name.exec(line)) {
                var level = match[1];
                var name = match[2];
                var java_name = toCamelCase(name);
                result += "//@CopyBookLine(\"" + line.trim() + "\")\n";
                if(name.match(/^\w{1,2}\d+/)) {
                    result += "//public class " + name + "() {\n";
                } else {
                    result += "//public class " + toCapitalCase(java_name) + "() {\n";
                }
            }
        }
        return result;
    }

    function toCamelCase(str) {
        return str.toLocaleLowerCase().replace(/([\-_]\w)/g, function(m){return m[1].toUpperCase();});
    }

    function toCapitalCase(str) {
        return str.charAt(0).toUpperCase() + str.slice(1)
    }

    $(function() {
        $('textarea[name="copybook"]').on("input", function() {
            var src = $('textarea[name="copybook"]').val();
            var dst = convertCopybook(src);
            $('textarea[name="javaclass"]').val(dst);
        });

    });
  </script>
</body>
</html>
